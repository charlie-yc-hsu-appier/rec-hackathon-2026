name: Update Vendor

on:
  # schedule:
  #   - cron: "0 2,8,14,20 * * *" # every day at 4AM, 10AM, 4PM, 10PM GMT+8
  workflow_dispatch: # allows manual trigger

env:
  VENDOR_CONFIG_FILE_PATH: "config-template/vendors.yaml"
  PR_BRANCH_NAME: "update-vendor"

jobs:
  update-vendor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate prompt file
        run: |
          cat > task-prompt.txt <<'EOF'
          You are an AI coding assistant.

          You have been assigned to work on the following task:

          read current vendor configuration from config-template/vendors.yaml
          compare and update the configuration according to the following json:
          {
            "name": "linkmine",
            "with_proxy": true,
            "http_method": "GET",
            "request": {
              "url": "https://testtttttt/reco/v2/",
              "queries": [
                {
                  "key": "app_code",
                  "value": "{subid}"
                },
                {
                  "key": "device_id",
                  "value": "{user_id_lower}"
                },
                {
                  "key": "device_lmt",
                  "value": "0"
                },
                {
                  "key": "imp_imageSize",
                  "value": "{width}x{height}"
                },
                {
                  "key": "app_bundleId",
                  "value": ""
                },
                {
                  "key": "imp_adType",
                  "value": "{adtype}"
                }
              ]
            },
            "tracking": {
              "url": "{product_url}",
              "queries": [
                {
                  "key": "param1",
                  "value": "{click_id_base64}"
                }
              ]
            }
          }

          Please implement the requested changes in this repository.

          EOF

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_vertex: 'true'
          claude_args: |
            --allowedTools BatchTool,Write,Edit,View,Glob,Grep,Bash,LS
          prompt_file: task-prompt.txt
          show_full_output: true

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update vendor config"
          branch: ${{ env.PR_BRANCH_NAME }}
          title: "[GitHub Action] Update Vendor Config"
          body: |
            Auto-generated update. The vendor configuration has been updated.
          assignees: yvonne-feng-appier

      # - name: Send Opsgenie Heartbeat on Success
      #   if: success()
      #   uses: fjogeleit/http-request-action@v1
      #   with:
      #     url: ${{ vars.OPSGENIE_HEARTBEAT_URL }}
      #     method: GET
      #     timeout: 1000 # ms
      #     retry: 3
      #     customHeaders: '{"Authorization": "GenieKey ${{ secrets.OPSGENIE_API_KEY }}"}'
