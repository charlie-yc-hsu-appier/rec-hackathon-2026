name: Update Vendor

on:
  # schedule:
  #   - cron: "0 2,8,14,20 * * *" # every day at 4AM, 10AM, 4PM, 10PM GMT+8
  workflow_dispatch: # allows manual trigger

env:
  VENDOR_CONFIG_FILE_PATH: "config-template/vendors.yaml"
  PR_BRANCH_NAME: "update-vendor-post-method"

jobs:
  update-vendor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate prompt file
        run: |
          cat > task-prompt.txt <<'EOF'
          You are an AI coding assistant.
          Read the current code base and modify the vendor "adpopcorn":

          the request method changes from GET to POST

          the request header is:
          ```{'Content-Type': 'application/json', 'User-Agent': 'tzyu.net'}```

          the request url is:
          ```https://ssp-ext-proxy.adpopcorn.com/coupang/reco/v2```

          the POST request body is
          ```
          {
              "app": {
                  "bundleId": ""
              },
              "device": {
                  "id": <user_id_lower>,
                  "lmt": 0
              },
              "imp": {
                  "imageSize": <width>x<height>
              },
              "affiliate": {
                  "subId": <subid>
              }
          }
          ```

          the response body will be:
          ```
          {
              "rCode": string,
              "rMessage": string,
              "data": {
                  "result": [
                      {
                          "productId": int,
                          "productUrl": string,
                          "productImage": string
                      }
                  ]
              }
          }
          ```

          Modify the config-template/vendors.yaml for the configuration change.

          Create a file to structure the POST body and name it as adpopcorn.go if it does not exist. Assign this body strategy to vendor "adpopcorn" in function `BuildBody` of file internal/strategy/builder.go.

          Read the current repo and find if there exists unmarshaler that already support parsing the above body, if no, create it. Assgin this unmarshaler to vendor "adpopcorn" in function `BuildUnmarshaler` of file internal/strategy/builder.go.

          Create or update the unit tests for the above changes.

          EOF

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action/base-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools Write,Edit,View,Bash
            --max-turns 100
          prompt_file: task-prompt.txt
          show_full_output: true

      - name: Remove prompt file
        run: rm task-prompt.txt

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update vendor config"
          branch: ${{ env.PR_BRANCH_NAME }}
          title: "[GitHub Action] Update Vendor Config"
          body: |
            Auto-generated update. The vendor configuration has been updated.
          assignees: yvonne-feng-appier
