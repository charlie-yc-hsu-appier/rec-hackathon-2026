name: Update Vendor

on:
  # schedule:
  #   - cron: "0 2,8,14,20 * * *" # every day at 4AM, 10AM, 4PM, 10PM GMT+8
  workflow_dispatch: # allows manual trigger

env:
  VENDOR_CONFIG_FILE_PATH: "config-template/vendors.yaml"
  PR_BRANCH_NAME: "github-action/update-vendor"
  BUILDER_FILE_PATH: "internal/strategy/builder.go"

jobs:
  update-vendor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set Up Inputs
        run: |
          VENDOR_DATA='{"name":"adpopcorn","with_proxy":true,"http_method":"POST","request":{"url":"https://ssp-ext-proxy.adpopcorn.com/coupang/reco/v2","queries":[],"body":{"app":{"bundleId":""},"device":{"id":"{user_id_lower}","lmt":0},"imp":{"imageSize":"{width}x{height}"},"affiliate":{"subId":"{subid}"}}},"tracking":{"url":"{product_url}","queries":[{"key":"subparam","value":"{click_id_base64}"}]},"response_body":{"rCode":"<string>","rMessage":"<string>","data":{"result":[{"productId":"<int>","productUrl":"<string>","productImage":"<string>"}]}},"headers":{"user_agent":"tzyu.net","content_type":"application/json"}}'
          echo "VENDOR_DATA=$VENDOR_DATA" >> $GITHUB_ENV

      - name: Define Vendor Name
        run: |
          VENDOR_NAME=${{ fromJson(env.VENDOR_DATA).name }}
          echo "VENDOR_NAME=$VENDOR_NAME" >> $GITHUB_ENV

      - name: Generate Prompt File
        run: |
          cat > task-prompt.txt <<EOF
          You are an AI coding assistant.

          Read the current vendor configuration from ${{ env.VENDOR_CONFIG_FILE_PATH }}
          Find the vendor named "${{ env.VENDOR_NAME }}" and update its configuration to match the following JSON: 
          ${{ env.VENDOR_DATA }}

          Note that the required fields of the vendor configuration are "name", "with_proxy", "http_method", "request.url", "request.queries" and "tracking.url". If any of these fields are not applicable, still keep them in the config with empty value.
          Note that "body", "response_body" and "headers" are not required fields in the vendor configuration, but they are important for the implementation. 
          
          If the request method is GET, you can ignore the "body". If there are new fields in queries, check if we can support the macro for the value, if not, add the support in the code base.
          
          If the request method is POST, you need to implement or update the "body" based on the provided JSON.
          Create a file to structure the POST body and name it as ${{ env.VENDOR_NAME }}.go, if it does not exist. 
          Assign this body strategy to vendor "${{ env.VENDOR_NAME }}" in function BuildBody of file ${{ env.BUILDER_FILE_PATH }}.
          
          Read the current repo and find if there exists unmarshaler that already support parsing the above response_body, if no, create it. Assign this unmarshaler to vendor "${{ env.VENDOR_NAME }}" in function BuildUnmarshaler of file ${{ env.BUILDER_FILE_PATH }}.
          
          Update the request header if there is any change. Create a file for header strategy if needed and assign it to the vendor in function BuildHeader of file ${{ env.BUILDER_FILE_PATH }}.
          
          Create or update the unit tests for the above changes. If there is just config update, no need to create or update unit tests.
          
          Finally, output the updated vendor configuration file content only. Make sure the output is a valid YAML content.
          
          EOF

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action/base-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools Write,Edit,View,Bash
            --max-turns 100
          prompt_file: task-prompt.txt
          show_full_output: true

      - name: Remove Temporary Files
        run: rm task-prompt.txt

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update vendor config"
          branch: ${{ env.PR_BRANCH_NAME }}
          title: "[GitHub Action] Update Vendor Config"
          body: |
            Auto-generated update. The vendor configuration has been updated.
          assignees: yvonne-feng-appier
