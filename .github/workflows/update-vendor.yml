name: Update Vendor

on:
  # schedule:
  #   - cron: "0 2,8,14,20 * * *" # every day at 4AM, 10AM, 4PM, 10PM GMT+8
  workflow_dispatch: # allows manual trigger

env:
  VENDOR_CONFIG_FILE_PATH: "config-template/vendors.yaml"
  PR_BRANCH_NAME: "update-vendor"

jobs:
  update-vendor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic pyyaml

      - name: Update vendor config with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python << 'EOF'
          import anthropic
          import os
          import json

          client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])

          # Read current vendor config
          with open('config-template/vendors.yaml', 'r') as f:
              current_config = f.read()

          new_vendor_config = {
              "name": "linkmine",
              "with_proxy": True,
              "http_method": "GET",
              "request": {
                  "url": "https://testtttttt/reco/v2/",
                  "queries": [
                      {"key": "app_code", "value": "{subid}"},
                      {"key": "device_id", "value": "{user_id_lower}"},
                      {"key": "device_lmt", "value": "0"},
                      {"key": "imp_imageSize", "value": "{width}x{height}"},
                      {"key": "app_bundleId", "value": ""},
                      {"key": "imp_adType", "value": "{adtype}"}
                  ]
              },
              "tracking": {
                  "url": "{product_url}",
                  "queries": [
                      {"key": "param1", "value": "{click_id_base64}"}
                  ]
              }
          }

          prompt = f"""Here is the current vendor configuration file:
          ```yaml
                    {current_config}
          ```

                    Please update this YAML file to include or update the vendor "linkmine" with the following configuration:
          ```json
                    {json.dumps(new_vendor_config, indent=2)}
          ```

          If the vendor "linkmine" already exists, update it. If it doesn't exist, add it to the vendors list.
          Preserve the YAML formatting and structure. Return ONLY the complete updated YAML file content, nothing else."""

          message = client.messages.create(
              model="claude-sonnet-4-5-20250929",
              max_tokens=4000,
              messages=[
                  {"role": "user", "content": prompt}
              ]
          )

          updated_config = message.content[0].text
          
          # Remove markdown code blocks if present
          if updated_config.startswith('```'):
              lines = updated_config.split('\n')
              updated_config = '\n'.join(lines[1:-1])

          # Write updated config
          with open('config-template/vendors.yaml', 'w') as f:
              f.write(updated_config)

          print("âœ… Vendor configuration updated successfully")
          EOF

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update vendor config"
          branch: ${{ env.PR_BRANCH_NAME }}
          title: "[GitHub Action] Update Vendor Config"
          body: |
            Auto-generated update. The vendor configuration has been updated.
          assignees: yvonne-feng-appier
